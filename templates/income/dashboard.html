{% extends "base.html" %}
{% load static %}

{% block link %}
<link href="{% static 'css/all.min.css' %}" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
<!-- FIXED: removed stray space in path -->
<link href="{% static 'css/sb-admin-2.min.css' %}" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock link %}

{% block content %}

<!-- Page Wrapper -->
<div id="wrapper">
  <!-- Content Wrapper -->
  <div id="content-wrapper" class="d-flex flex-column">
    <!-- Main Content -->
    <div id="content">

      <!-- Begin Page Content -->
      <div class="container-fluid">

        <!-- Page Heading -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
          <h1 class="h3 mb-0 text-gray-800">Income Summary</h1>
        </div>

        <!-- KPI Row -->
        <div class="row">
          <!-- Monthly -->
          <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100 py-2">
              <div class="card-body d-flex flex-column align-items-center justify-content-center">
                <div class="text-xs font-weight-bold text-success text-uppercase mb-2" style="font-size:1.1rem;">
                  Earnings (Monthly)
                </div>
                <div class="h3 mb-2 font-weight-bold" style="color:var(--primary-black);">
                  &#8377; {{ monthly_income|floatformat:2 }}
                </div>
                <div class="progress w-100" style="height:8px;">
                  <div class="progress-bar bg-success" role="progressbar" style="width: 70%;" aria-valuenow="70"
                       aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Yearly -->
          <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100 py-2">
              <div class="card-body d-flex flex-column align-items-center justify-content-center">
                <div class="text-xs font-weight-bold text-warning text-uppercase mb-2" style="font-size:1.1rem;">
                  Earnings (Yearly)
                </div>
                <div class="h3 mb-2 font-weight-bold" style="color:var(--primary-black);">
                  &#8377; {{ yearly_income|floatformat:2 }}
                </div>
                <div class="progress w-100" style="height:8px;">
                  <div class="progress-bar bg-warning" role="progressbar" style="width: 90%;" aria-valuenow="90"
                       aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Weekly -->
          <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100 py-2">
              <div class="card-body d-flex flex-column align-items-center justify-content-center">
                <div class="text-xs font-weight-bold text-primary text-uppercase mb-2" style="font-size:1.1rem;">
                  Earnings (Weekly)
                </div>
                <div class="h3 mb-2 font-weight-bold" style="color:var(--primary-black);">
                  &#8377; {{ weekly_income|floatformat:2 }}
                </div>
                <div class="progress w-100" style="height:8px;">
                  <div class="progress-bar bg-primary" role="progressbar" style="width: 60%;" aria-valuenow="60"
                       aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Daily -->
          <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100 py-2">
              <div class="card-body d-flex flex-column align-items-center justify-content-center">
                <div class="text-xs font-weight-bold text-info text-uppercase mb-2" style="font-size:1.1rem;">
                  Earnings (Daily)
                </div>
                <div class="h3 mb-2 font-weight-bold" style="color:var(--primary-black);">
                  &#8377; {{ daily_income|floatformat:2 }}
                </div>
                <div class="progress w-100" style="height:8px;">
                  <div class="progress-bar bg-info" role="progressbar" style="width: 40%;" aria-valuenow="40"
                       aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="row justify-content-center">
          <!-- Area Chart -->
          <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
              <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Earnings Overview</h6>
              </div>
              <div class="card-body">
                <div class="chart-area">
                  <canvas id="myAreaChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- (Optional) Pie Chart block removed/commented -->
        </div>

      </div>
      <!-- /.container-fluid -->

    </div>
    <!-- End of Main Content -->
  </div>
  <!-- End of Content Wrapper -->
</div>
<!-- End of Page Wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
  <i class="fas fa-angle-up"></i>
</a>

<!-- Scripts -->
<script src="{% static 'js/jquery.min.js' %}"></script>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'js/jquery.easing.min.js' %}"></script>
<script src="{% static 'js/sb-admin-2.min.js' %}"></script>
<script src="{% static 'js/Chart.min.js' %}"></script>

{% endblock content %}

{% block js %}
<script>
  // Build Chart.js gradient line chart for Earnings Overview (dynamic via endpoint)
  const ctx = document.getElementById('myAreaChart').getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 600, 0);
  gradient.addColorStop(0, '#2563eb'); // blue
  gradient.addColorStop(0.5, '#22c55e'); // green
  gradient.addColorStop(1, '#FDBA74'); // peach

  // Initialize with zeros; we will replace with API response
  const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let dataPoints = new Array(12).fill(0);

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Earnings',
        data: dataPoints,
        borderColor: gradient,
        backgroundColor: 'rgba(37,99,235,0.08)',
        borderWidth: 3,
        pointBackgroundColor: '#FDBA74',
        pointRadius: 4,
        fill: true,
        tension: 0.35
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: true,
          callbacks: {
            label: function(context) {
              const y = context.parsed.y || 0;
              return '₹ ' + Number(y).toLocaleString(undefined, {maximumFractionDigits: 2});
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#6B7280' }
        },
        y: {
          grid: { color: '#e5e7eb' },
          ticks: {
            color: '#6B7280',
            callback: function(value) {
              return '₹ ' + Number(value).toLocaleString();
            }
          }
        }
      }
    }
  });

  // Fetch monthly income via your Django URL name "monthly_income_data"
  (function loadMonthlyIncome() {
    fetch("{% url 'monthly_income_data' %}")
      .then(r => r.json())
      .then(json => {
        const series = json.monthly_income_data || json.monthly_data || [];
        if (Array.isArray(series) && series.length === 12) {
          chart.data.datasets[0].data = series.map(Number);
          chart.update();
        }
      })
      .catch(() => {
        // silently keep zeros on error
      });
  })();
</script>
{% endblock js %}
