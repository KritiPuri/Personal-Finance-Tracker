{% extends "base.html" %}

{% load static %}


{% block content %}

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'expenses'%}">Expenses</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Add Expenses</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-body">
            <form action="{% url 'add-expenses' %}" method="post" id="expense-form">
                {% include 'partials/_messages.html'%}
                {% csrf_token %}
                <div class="form-group">
                    <label for="">Amount</label>
                    <input type="number" class="form-control form-control-sm" name="amount" value="{{values.amount}}" />
                </div>
                <div class="form-group">
                    <label for="">Description</label>
                    <input type="text" class="form-control form-control-sm" name="description" id="description-input"
                        value="{{values.description}}" />

                    <!-- Loading indicator -->
                    <div id="loading-indicator" style="display: none;">
                        <img class="loader" src="{% static 'img/loader.gif' %}" alt="Loading..." width="25">
                    </div>

                    <!-- Predicted category display -->
                    <!-- <div id="predicted-category" style="margin-top: 5px;"></div> -->
                </div>
                <!-- <div class="form-group">
                    <label for="">Category</label>
                    <select class="form-control" name="category" id="category-select">
                        {% for category in categories%}
                        <option name="category" value="{{category.name}}">{{category.name}}</option>
                        {% endfor %}
                    </select>
                </div> -->
                <input type="hidden" name="initial_predicted_category" id="initial-predicted-category"
                    value="{{predicted_category}}">


                <div class="form-group">
                    <label for="">Category</label>
                    <input type="text" class="form-control" name="category" id="category-input"
                        value="{{values.category}}" />
                </div>


                <div class="form-group">
                    <label for="">Date of Expense</label>
                    <input type="date" class="form-control form-control-sm" name="expense_date" />
                </div>

                <input type="submit" id="btn" value="Submit" class="btn btn-primary btn-primary-sm" />
            </form>
        </div>
    </div>
</div>
{% endblock content %}

<!-- Add JavaScript to make category predictions -->
{% block js %}
<script>
// Function to predict category based on description
function predictCategory() {
    const description = document.getElementById('description-input').value.trim();
    const categoryInput = document.getElementById('category-input');
    
    // Only predict if description has at least 2 characters
    if (description && description.length >= 2) {
        // Display the loading indicator
        const loadingIndicator = document.getElementById('loading-indicator');
        if (loadingIndicator) {
            loadingIndicator.style.display = 'inline';
        }
        
        // Show predicting status
        categoryInput.value = "Predicting...";
        categoryInput.style.color = "green";
        categoryInput.disabled = true;
        
        // Send a request to your server to predict the category
        fetch('{% url "predict-category" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ description: description })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Hide the loading indicator
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            // Update the category input with the predicted category
            if (data.predicted_category) {
                categoryInput.value = data.predicted_category;
                categoryInput.style.color = "black";
                categoryInput.disabled = false;
            } else {
                categoryInput.value = "";
                categoryInput.style.color = "black";
                categoryInput.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error predicting category:', error);
            // Hide the loading indicator in case of an error
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            // Reset category input
            categoryInput.value = "";
            categoryInput.style.color = "red";
            categoryInput.placeholder = "Error predicting category";
            categoryInput.disabled = false;
            
            // Show error message if user is not authenticated
            if (error.message.includes('401') || error.message.includes('403')) {
                alert('Please login to use category prediction');
            }
        });
    } else {
        // Clear category if description is too short
        categoryInput.value = "";
        categoryInput.style.color = "black";
        categoryInput.disabled = false;
    }
}

// Function to get the CSRF token from cookies
function getCookie(name) {
const value = `; ${document.cookie}`;
const parts = value.split(`; ${name}=`);
if (parts.length === 2) return parts.pop().split(';').shift();
}

// Listen for input changes in the description field with debouncing
const descriptionInput = document.getElementById('description-input');
let debounceTimer;
descriptionInput.addEventListener('input', function() {
    // Clear previous timer
    clearTimeout(debounceTimer);
    // Set new timer to call predictCategory after 500ms of no typing
    debounceTimer = setTimeout(predictCategory, 500);
});
</script>
{% endblock js %}